var ISO_PATTERN=new RegExp("(\\d{4}-[01]\\d-[0-3]\\dT[0-2]\\d:[0-5]\\d:[0-5]\\d\\.\\d+([+-][0-2]\\d:[0-5]\\d|Z))|(\\d{4}-[01]\\d-[0-3]\\dT[0-2]\\d:[0-5]\\d:[0-5]\\d([+-][0-2]\\d:[0-5]\\d|Z))|(\\d{4}-[01]\\d-[0-3]\\dT[0-2]\\d:[0-5]\\d([+-][0-2]\\d:[0-5]\\d|Z))"),TIME_PATTERN=new RegExp("PT(?:(\\d+)H)?(?:(\\d+)M)?(?:(\\d+)(?:\\.(\\d+)?)?S)?"),DEP_PATTERN=new RegExp("\\{\\{(.*?)\\|raw\\}\\}");angular.module("datasourcejs",[]).factory("DatasetManager",["$http","$q","$timeout","$rootScope","$window","Notification",function($http,$q,$timeout,$rootScope,$window,Notification){this.datasets={};var DataSet=function(name,scope){function reverseArr(t){if(t){for(var e=new Array,s=t.length-1;s>=0;s--)e.push(t[s]);return e}return[]}function toBase64(t,e){var s=new FileReader;s.readAsDataURL(t),s.onload=function(t){var s=t.target.result.substr(t.target.result.indexOf("base64,")+"base64,".length);e(s)}}function uuid(){var t,e,s="";for(t=0;t<32;t++)e=16*Math.random()|0,8!=t&&12!=t&&16!=t&&20!=t||(s+="-"),s+=(12==t?4:16==t?3&e|8:e).toString(16);return s}var NO_IMAGE_UPLOAD="data:image/svg+xml;utf8;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iaXNvLTg4NTktMSI/Pgo8IS0tIEdlbmVyYXRvcjogQWRvYmUgSWxsdXN0cmF0b3IgMTYuMC4wLCBTVkcgRXhwb3J0IFBsdWctSW4gLiBTVkcgVmVyc2lvbjogNi4wMCBCdWlsZCAwKSAgLS0+CjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+CjxzdmcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIgdmVyc2lvbj0iMS4xIiBpZD0iQ2FwYV8xIiB4PSIwcHgiIHk9IjBweCIgd2lkdGg9IjEyOHB4IiBoZWlnaHQ9IjEyOHB4IiB2aWV3Qm94PSIwIDAgNDQuNTAyIDQ0LjUwMiIgc3R5bGU9ImVuYWJsZS1iYWNrZ3JvdW5kOm5ldyAwIDAgNDQuNTAyIDQ0LjUwMjsiIHhtbDpzcGFjZT0icHJlc2VydmUiPgo8Zz4KCTxnPgoJCTxwYXRoIGQ9Ik05Ljg2MiwzNS42MzhoMjQuNzc5YzAtNS41NDYtMy44NjMtMTAuMjAzLTkuMTEzLTExLjYwNGMyLjc1LTEuMjQ4LDQuNjY4LTQuMDEzLDQuNjY4LTcuMjI5ICAgIGMwLTQuMzg4LTMuNTU5LTcuOTQyLTcuOTQyLTcuOTQyYy00LjM4NywwLTcuOTQzLDMuNTU3LTcuOTQzLDcuOTQyYzAsMy4yMTksMS45MTYsNS45OCw0LjY2OCw3LjIyOSAgICBDMTMuNzI1LDI1LjQzNSw5Ljg2MiwzMC4wOTIsOS44NjIsMzUuNjM4eiIgZmlsbD0iIzkxOTE5MSIvPgoJCTxwYXRoIGQ9Ik0xLjUsMTQuMTY5YzAuODI4LDAsMS41LTAuNjcyLDEuNS0xLjVWNC4zMzNoOC4zMzZjMC44MjgsMCwxLjUtMC42NzIsMS41LTEuNWMwLTAuODI4LTAuNjcyLTEuNS0xLjUtMS41SDIuNzc1ICAgIEMxLjI0NCwxLjMzMywwLDIuNTc3LDAsNC4xMDh2OC41NjFDMCwxMy40OTcsMC42NywxNC4xNjksMS41LDE0LjE2OXoiIGZpbGw9IiM5MTkxOTEiLz4KCQk8cGF0aCBkPSJNNDEuNzI3LDEuMzMzaC04LjU2MmMtMC44MjcsMC0xLjUsMC42NzItMS41LDEuNWMwLDAuODI4LDAuNjczLDEuNSwxLjUsMS41aDguMzM2djguMzM2YzAsMC44MjgsMC42NzMsMS41LDEuNSwxLjUgICAgczEuNS0wLjY3MiwxLjUtMS41di04LjU2QzQ0LjUwMiwyLjU3OSw0My4yNTYsMS4zMzMsNDEuNzI3LDEuMzMzeiIgZmlsbD0iIzkxOTE5MSIvPgoJCTxwYXRoIGQ9Ik00My4wMDIsMzAuMzMzYy0wLjgyOCwwLTEuNSwwLjY3Mi0xLjUsMS41djguMzM2aC04LjMzNmMtMC44MjgsMC0xLjUsMC42NzItMS41LDEuNXMwLjY3MiwxLjUsMS41LDEuNWg4LjU2ICAgIGMxLjUzLDAsMi43NzYtMS4yNDYsMi43NzYtMi43NzZ2LTguNTZDNDQuNTAyLDMxLjAwNSw0My44MywzMC4zMzMsNDMuMDAyLDMwLjMzM3oiIGZpbGw9IiM5MTkxOTEiLz4KCQk8cGF0aCBkPSJNMTEuMzM2LDQwLjE2OUgzdi04LjMzNmMwLTAuODI4LTAuNjcyLTEuNS0xLjUtMS41Yy0wLjgzLDAtMS41LDAuNjcyLTEuNSwxLjV2OC41NmMwLDEuNTMsMS4yNDQsMi43NzYsMi43NzUsMi43NzZoOC41NjEgICAgYzAuODI4LDAsMS41LTAuNjcyLDEuNS0xLjVTMTIuMTY1LDQwLjE2OSwxMS4zMzYsNDAuMTY5eiIgZmlsbD0iIzkxOTE5MSIvPgoJPC9nPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+Cjwvc3ZnPgo=",NO_FILE_UPLOAD="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iaXNvLTg4NTktMSI/Pgo8IS0tIEdlbmVyYXRvcjogQWRvYmUgSWxsdXN0cmF0b3IgMTYuMC4wLCBTVkcgRXhwb3J0IFBsdWctSW4gLiBTVkcgVmVyc2lvbjogNi4wMCBCdWlsZCAwKSAgLS0+CjwhRE9DVFlQRSBzdmcgUFVCTElDICItLy9XM0MvL0RURCBTVkcgMS4xLy9FTiIgImh0dHA6Ly93d3cudzMub3JnL0dyYXBoaWNzL1NWRy8xLjEvRFREL3N2ZzExLmR0ZCI+CjxzdmcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIgdmVyc2lvbj0iMS4xIiBpZD0iQ2FwYV8xIiB4PSIwcHgiIHk9IjBweCIgd2lkdGg9IjUxMnB4IiBoZWlnaHQ9IjUxMnB4IiB2aWV3Qm94PSIwIDAgNTQ4LjE3NiA1NDguMTc2IiBzdHlsZT0iZW5hYmxlLWJhY2tncm91bmQ6bmV3IDAgMCA1NDguMTc2IDU0OC4xNzY7IiB4bWw6c3BhY2U9InByZXNlcnZlIj4KPGc+Cgk8cGF0aCBkPSJNNTI0LjMyNiwyOTcuMzUyYy0xNS44OTYtMTkuODktMzYuMjEtMzIuNzgyLTYwLjk1OS0zOC42ODRjNy44MS0xMS44LDExLjcwNC0yNC45MzQsMTEuNzA0LTM5LjM5OSAgIGMwLTIwLjE3Ny03LjEzOS0zNy40MDEtMjEuNDA5LTUxLjY3OGMtMTQuMjczLTE0LjI3Mi0zMS40OTgtMjEuNDExLTUxLjY3NS0yMS40MTFjLTE4LjA4MywwLTMzLjg3OSw1LjkwMS00Ny4zOSwxNy43MDMgICBjLTExLjIyNS0yNy40MS0yOS4xNzEtNDkuMzkzLTUzLjgxNy02NS45NWMtMjQuNjQ2LTE2LjU2Mi01MS44MTgtMjQuODQyLTgxLjUxNC0yNC44NDJjLTQwLjM0OSwwLTc0LjgwMiwxNC4yNzktMTAzLjM1Myw0Mi44MyAgIGMtMjguNTUzLDI4LjU0NC00Mi44MjUsNjIuOTk5LTQyLjgyNSwxMDMuMzUxYzAsMi40NzQsMC4xOTEsNi41NjcsMC41NzEsMTIuMjc1Yy0yMi40NTksMTAuNDY5LTQwLjM0OSwyNi4xNzEtNTMuNjc2LDQ3LjEwNiAgIEM2LjY2MSwyOTkuNTk0LDAsMzIyLjQzLDAsMzQ3LjE3OWMwLDM1LjIxNCwxMi41MTcsNjUuMzI5LDM3LjU0NCw5MC4zNThjMjUuMDI4LDI1LjAzNyw1NS4xNSwzNy41NDgsOTAuMzYyLDM3LjU0OGgzMTAuNjM2ICAgYzMwLjI1OSwwLDU2LjA5Ni0xMC43MTEsNzcuNTEyLTMyLjEyYzIxLjQxMy0yMS40MDksMzIuMTIxLTQ3LjI0NiwzMi4xMjEtNzcuNTE2QzU0OC4xNzIsMzM5Ljk0NCw1NDAuMjIzLDMxNy4yNDgsNTI0LjMyNiwyOTcuMzUyICAgeiBNMzYyLjcyOSwyODkuNjQ4Yy0xLjgxMywxLjgwNC0zLjk0OSwyLjcwNy02LjQyLDIuNzA3aC02My45NTN2MTAwLjUwMmMwLDIuNDcxLTAuOTAzLDQuNjEzLTIuNzExLDYuNDIgICBjLTEuODEzLDEuODEzLTMuOTQ5LDIuNzExLTYuNDIsMi43MTFoLTU0LjgyNmMtMi40NzQsMC00LjYxNS0wLjg5Ny02LjQyMy0yLjcxMWMtMS44MDQtMS44MDctMi43MTItMy45NDktMi43MTItNi40MlYyOTIuMzU1ICAgSDE1NS4zMWMtMi42NjIsMC00Ljg1My0wLjg1NS02LjU2My0yLjU2M2MtMS43MTMtMS43MTQtMi41NjgtMy45MDQtMi41NjgtNi41NjZjMC0yLjI4NiwwLjk1LTQuNTcyLDIuODUyLTYuODU1bDEwMC4yMTMtMTAwLjIxICAgYzEuNzEzLTEuNzE0LDMuOTAzLTIuNTcsNi41NjctMi41N2MyLjY2NiwwLDQuODU2LDAuODU2LDYuNTY3LDIuNTdsMTAwLjQ5OSwxMDAuNDk1YzEuNzE0LDEuNzEyLDIuNTYyLDMuOTAxLDIuNTYyLDYuNTcxICAgQzM2NS40MzgsMjg1LjY5NiwzNjQuNTM1LDI4Ny44NDUsMzYyLjcyOSwyODkuNjQ4eiIgZmlsbD0iI2NlY2VjZSIvPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+CjxnPgo8L2c+Cjwvc3ZnPgo=";this.Notification=Notification,this.$scope=scope,this.noImageUpload=NO_IMAGE_UPLOAD,this.noFileUpload=NO_FILE_UPLOAD,this.$apply=function(t){scope.$apply(t)}.bind(scope),this.columns=[],this.data=[],this.name=name,this.keys=[],this.enabled=!0,this.endpoint=null,this.active={},this.inserting=!1,this.editing=!1,this.fetchSize=2,this.observers=[],this.rowsPerPage=null,this.append=!0,this.headers=null,this.responseHeaders=null,this._activeValues=null,this.errorMessage="",this.onError=null,this.links=null,this.loadedFinish=null,this.lastFilterParsed=null,this.rowsCount=-1,this.events={},this.busy=!1,this.cursor=0,this._savedProps,this.hasMoreResults=!1,this.loaded=!1,this.unregisterDataWatch=null,this.dependentBufferLazyPostData=null,this.lastAction=null,this.dependentData=null,this.hasMemoryData=!1,this.batchPost=!1,this.caseInsensitive=null,this.terms=null,this.checkRequired=!0;var _self=this,service=null;this.init=function(){var dsScope=this;service={save:function(t){return this.call(_self.entity,"POST",t,!0)},update:function(t,e){return this.call(t,"PUT",e,!1)},remove:function(t){return this.call(t,"DELETE",null,!0)},call:function(t,e,s,i){var a={},r=t.indexOf("/cronapi/query/")>=0;if(r){a.inputs=[s];var n,o,h={};if(_self.busy=!0,t=t.replace("/specificSearch",""),t=t.replace("/generalSearch",""),_self&&_self.$scope&&_self.$scope.vars){h.vars={};for(var c in _self.$scope.vars)h.vars[c]=_self.$scope.vars[c]}for(var d in _self.$scope)_self.$scope[d]&&_self.$scope[d].constructor&&"DataSet"==_self.$scope[d].constructor.name&&(h[d]={},h[d].active=_self.$scope[d].active);a.fields=h}else a=s;var l={};return _self.copy(a,l),delete l.__original,delete l.__status,delete l.__originalIdx,delete l.__sender,delete l.__$id,delete l.__parentId,delete l.$$hashKey,delete l.__fromMemory,this.$promise=$http({method:e,url:_self.removeSlash((window.hostApp||"")+t),data:a?JSON.stringify(l):null,headers:_self.headers}).success(function(t,s,i,a){if(_self.busy=!1,n&&(_self.isOData()?"GET"==e?(_self.normalizeData(t.d.results),n(t.d.results,!0)):(_self.normalizeObject(t.d),n(t.d,!0)):n(r?t.value:t,!0)),r||_self.isOData()){var o=t;_self.isOData()&&(o={},o.commands=t.__callback,_self.normalizeData(o.commands)),_self.$scope.cronapi.evalInContext(JSON.stringify(o))}}).error(function(t,e,s,i){_self.busy=!1;var a;a=_self.isOData()?t.error.message.value:r&&t.value?t.value:t,_self.handleError(a),o&&o(a)}),this.$promise.then=function(t){return n=t,this},this.$promise.error=function(t){return o=t,this},this}},this.isBusy=function(){return this.busy},this.isLoaded=function(){return this.loaded},this.toString=function(){return"[Datasource]"},this.handleAfterCallBack=function(t){if(t)try{var e={currentData:this.data,datasource:this,selectedIndex:this.cursor,index:this.cursor,selectedRow:this.active,item:this.active,selectedKeys:this.getKeyValues(this.active,!0)};this.$scope.$eval(t,e)}catch(t){this.handleError(t)}},this.handleBeforeCallBack=function(t){var e=!0;if(t)try{var s={currentData:this.data,datasource:this,selectedIndex:this.cursor,index:this.cursor,selectedRow:this.active,item:this.active,selectedKeys:this.getKeyValues(this.active,!0)};this.$scope.$eval(t,s)}catch(t){e=!1,this.handleError(t)}return e},this.handleError=function(data){console.log(data);var error="";if(data)if("[object String]"===Object.prototype.toString.call(data))error=data;else{var errorMsg=data.msg||data.desc||data.message||data.error||data.responseText;this.isOData()&&(errorMsg=data.error.message.value),errorMsg&&(error=errorMsg)}error||(error=this.defaultNotSpecifiedErrorMessage);var regex=/<h1>(.*)<\/h1>/gim;if(result=regex.exec(error),result&&result.length>=2&&(error=result[1]),this.errorMessage=error,this.onError&&""!=this.onError){if("string"==typeof this.onError)try{var indexFunc=-1==this.onError.indexOf("(")?this.onError.length:this.onError.indexOf("("),func=eval(this.onError.substring(0,indexFunc));"function"==typeof func&&(this.onError=func)}catch(t){isValid=!1,Notification.error(t)}}else this.onError=function(t){Notification.error(t)};this.onError.call(this,error)},this.observers&&this.observers.length>0&&$rootScope.$watch(function(){return this.active}.bind(this),function(t){t&&this.notifyObservers(t)}.bind(this),!0)},this.setFile=function(t,e,s){t&&"pattern"===t.$error||t&&toBase64(t,function(t){this.$apply=function(t){e[s]=t,scope.$apply(e)}.bind(scope),this.$apply(t)})},this.downloadFile=function(t,e){if(void 0!==e){for(var s=(window.hostApp||"")+this.entity+"/download/"+t,i=0;i<e.length;i++)s+="/"+e[i];$http({url:s,method:"GET",responseType:"arraybuffer"}).then(function(t){var e=new Blob([t.data],{type:"application/*"});$window.open(URL.createObjectURL(e))})}},this.openImage=function(t){if(-1==t.indexOf("https://")&&-1==t.indexOf("http://")){var e="data:image/png;base64,"+t;$window.open("","_blank","height=300,width=400").document.write('<img src="'+e+'"/>')}else $window.open(t,"_blank","height=300,width=400")},this.byteSize=function(t){function e(t,e){return-1!==e.indexOf(t,e.length-t.length)}function s(t){return e("==",t)?2:e("=",t)?1:0}return angular.isString(t)?function(t){return t.toString().replace(/\B(?=(\d{3})+(?!\d))/g," ")+" bytes"}(function(t){return t.length/4*3-s(t)}(t)):""},this.insert=function(obj,onSuccess,onError,forceSave){this.handleBeforeCallBack(this.onBeforeCreate)&&(!this.dependentLazyPost&&!this.batchPost||forceSave?service.save(obj).$promise.error(onError).then(onSuccess):(obj.__status="inserted",this.dependentLazyPost&&(obj.__parentId=eval(this.dependentLazyPost).active.__$id),this.hasMemoryData=!0,onSuccess&&onSuccess(obj)))},this.addDependentDatasource=function(dts){this.children||(this.children=[]),this.children.push(dts),this.dependentLazyPost?eval(this.dependentLazyPost).addDependentDatasource(dts):(this.dependentData||(this.dependentData=[]),this.dependentData.push(dts))},this.updateObjectAtIndex=function(t,e,s){e=e||this.data,this.copy(e[s],t),delete e[s].__status,delete e[s].__original,delete e[s].__originalIdx},this.cleanDependentBuffer=function(){var t=[];$(this.data).each(function(){this.__status?"updated"==this.__status&&t.push(this.__original):t.push(this)}),this.data.length=0;for(var e=0;e<t.length;e++)delete t[e].__status,delete t[e].__original,delete t[e].__originalIdx,this.data.push(t[e]);if(this.postDeleteData)for(var e=0;e<this.postDeleteData.length;e++)delete this.postDeleteData[e].__status,delete this.postDeleteData[e].__original,delete this.postDeleteData[e].__originalIdx,this.data.push(this.postDeleteData[e]);this.data&&this.data.length>0?(this.cursor=0,this.active=this.data[0]):(this.cursor=-1,this.active=null),this.busy=!1,this.editing=!1,this.inserting=!1,this.postDeleteData=null,this.hasMemoryData=!1,this.events.read&&this.callDataSourceEvents("read",this.data)},this.cancelBatchData=function(t){this.dependentData&&$(reverseArr(this.dependentData)).each(function(){this.cleanDependentBuffer()}),this.cleanDependentBuffer(),t&&t()},this.flushDependencies=function(t){if(this.dependentData){var e=function(){reduce(this.dependentData,function(t,e){t.storeDependentBuffer(function(){e()})}.bind(this),function(){t&&t()}.bind(this))}.bind(this);reduce(reverseArr(this.dependentData),function(t,e){t.storeDependentBuffer(function(){e()},!0)}.bind(this),function(){e()}.bind(this))}else t&&t()},this.postBatchData=function(t){var e=function(){this.storeDependentBuffer(function(){reduce(this.dependentData,function(t,e){t.storeDependentBuffer(function(){e()})}.bind(this),function(){t&&t()}.bind(this))}.bind(this))}.bind(this);reduce(reverseArr(this.dependentData),function(t,e){t.storeDependentBuffer(function(){e()},!0)}.bind(this),function(){e()}.bind(this))};var reduce=function(t,e,s){if(t&&0!=t.length){t.reduce(function(t,s){return t.then(function(){return new Promise(function(t){e(s,t)})})},Promise.resolve()).then(function(){s()})}else s()};this.storeDependentBuffer=function(callback,onlyRemove){var _self=this,dependentDS=eval(_self.dependentLazyPost);this.batchPost&&(dependentDS=this);var array=[];if(!onlyRemove&&(array=array.concat(_self.data),_self.memoryData))for(key in _self.memoryData)if(_self.memoryData.hasOwnProperty(key)){for(var mem=_self.memoryData[key],x=0;x<mem.data.length;x++)mem.data[x].__fromMemory=!0;array=array.concat(mem.data)}_self.postDeleteData&&(array=array.concat(_self.postDeleteData));var func=function(t,e){if(t.__status){if(!_self.parameters&&(_self.dependentLazyPostField&&(t[_self.dependentLazyPostField]=dependentDS.active),_self.entity.indexOf("//")>-1)){var s=dependentDS.getKeyValues(dependentDS.active),i="";for(var a in s)s.hasOwnProperty(a)&&(i+="/"+s[a]);i+="/",_self.entity=_self.entity.replace("//",i)}if(_self.parameters){var r=_self.getParametersMap(t.__parentId?t.__parentId:null);for(var a in r)r.hasOwnProperty(a)&&updateObjectValue(t,a,r[a])}"inserted"==t.__status?function(t){_self.insert(t,function(s){var i=t.__sender,a=_self.getIndexOfListTempBuffer(t,array),r=!1;a>=0&&(r=array[a].__fromMemory,_self.updateObjectAtIndex(s,array,a)),_self.events.create&&!r&&(i&&(s=array[a],s.__sender=i),_self.callDataSourceEvents("create",s),delete s.__sender),e()},function(){e()},!0)}(t):"updated"==t.__status?function(t){_self.update(t,function(s){var i=t.__sender,a=_self.getIndexOfListTempBuffer(t,array),r=!1;a>=0&&(r=array[a].__fromMemory,_self.updateObjectAtIndex(s,array,a),s=array[a]),_self.events.update&&!r&&(i&&(s.__sender=i),_self.callDataSourceEvents("update",s),delete s.__sender),e()},function(){e()},!0)}(t):"deleted"==t.__status?function(t){_self.remove(t,function(){if(_self.events.delete){var s={};_self.copy(t,s),delete s.__status,delete s.__original,delete s.__originalIdx,_self.callDataSourceEvents("delete",s)}e()},!0,null,function(){e()})}(t):e()}else e()};reduce(array,func,function(){onlyRemove||(this.busy=!1,this.editing=!1,this.inserting=!1,this.hasMemoryData=!1,this.memoryData=null),this.postDeleteData=null,callback&&callback()}.bind(this))},this.getIndexOfListTempBuffer=function(t,e){e=e||this.data;for(var s=0;s<e.length;s++)if(e[s].__$id&&t.__$id&&e[s].__$id==t.__$id)return s;return-1},this.getObjectAsString=function(t){return this.isOData()?null==t?"null":"number"==typeof t||"boolean"==typeof t?t+"":t instanceof Date?"datetimeoffset'"+t.toISOString()+"'":"'"+t+"'":null==t?"":"number"==typeof t?t+"@@number":t instanceof Date?t.toISOString()+"@@datetime":"boolean"==typeof t?t+"@@boolean":t+""},this.update=function(t,e,s,i){this.handleBeforeCallBack(this.onBeforeUpdate)&&(!this.dependentLazyPost&&!this.batchPost||i?service.update(this.getEditionURL(t,i),t).$promise.error(s).then(e):e&&e(t))},this.missingRequiredField=function(){return!!this.checkRequired&&($('[required][ng-model*="'+this.name+'."]').hasClass("ng-invalid-required")||$('[ng-model*="'+this.name+'."]').hasClass("ng-invalid")||$('[required][ng-model*="'+this.name+'."]').hasClass("ng-empty")||$('[valid][ng-model*="'+this.name+'."]').hasClass("ng-empty"))},this.hasInvalidField=function(){return!!this.checkRequired&&$('input[ng-model*="'+this.name+'."]:invalid').size()>0},this.postSilent=function(t,e){this.post(t,e,!0)},this.updateActive=function(t){for(var e in t)t.hasOwnProperty(e)&&(this.active[e]=t[e])},this.post=function(onSuccess,onError,silent){!silent&&this.missingRequiredField()||!silent&&this.hasInvalidField()||(this.lastAction="post",this.busy=!0,this.inserting?this.insert(this.active,function(t,e){this.active.__sender&&(t.__sender=this.active.__sender),this.active.__$id&&(t.__$id=this.active.__$id),this.data.push(t);var s=function(){this.active=t,this.handleAfterCallBack(this.onAfterCreate),this.onBackNomalState(),onSuccess&&onSuccess(this.active),this.events.create&&e&&(this.callDataSourceEvents("create",this.active),delete this.active.__sender),this.events.memorycreate&&!e&&this.callDataSourceEvents("memorycreate",this.active)}.bind(this);!this.dependentData||this.dependentLazyPost||this.batchPost?s():this.flushDependencies(s)}.bind(this),onError):this.editing&&this.update(this.active,function(obj,hotData){var keyObj=this.getKeyValues(this.lastActive);this.data.forEach(function(currentRow){var found;if(this.lastActive.__$id&&currentRow.__$id)found=this.lastActive.__$id==currentRow.__$id;else{var dataKeys=this.getKeyValues(currentRow);for(var key in keyObj){if(!dataKeys[key]||dataKeys[key]!==keyObj[key]){found=!1;break}found=!0}}if(found){var lastActive={};this.copy(this.lastActive,lastActive),this.copy(obj,currentRow),this.lastActive&&this.lastActive.__sender&&(currentRow.__sender=this.lastActive.__sender),this.active=currentRow,!this.dependentLazyPost&&!this.batchPost||currentRow.__status||(currentRow.__status="updated",currentRow.__original=lastActive,this.hasMemoryData=!0,this.dependentLazyPost&&(currentRow.__parentId=eval(this.dependentLazyPost).active.__$id)),this.handleAfterCallBack(this.onAfterUpdate),this.events.update&&hotData&&(this.callDataSourceEvents("update",this.active),delete this.active.__sender),this.events.memoryupdate&&!hotData&&this.callDataSourceEvents("memoryupdate",this.active)}}.bind(this));var func=function(){this.onBackNomalState(),onSuccess&&onSuccess(this.active)}.bind(this);!this.dependentData||this.dependentLazyPost||this.batchPost?func():this.flushDependencies(func)}.bind(this),onError))},this.getDeletionURL=function(t,e){var s=this.getKeyValues(t.__original?t.__original:t,e),i="";this.isOData()&&(i="(");for(var a in s)s.hasOwnProperty(a)&&(this.isOData()?i+=a+"="+this.getObjectAsString(s[a]):i+="/"+s[a]);this.isOData()&&(i+=")");var r=this.entity;return this.entity.endsWith("/")&&(r=r.substring(0,r.length-1)),r+i},this.getEditionURL=function(t,e){var s=this.getKeyValues(t.__original?t.__original:t,e),i="";this.isOData()&&(i="(");for(var a in s)s.hasOwnProperty(a)&&(this.isOData()?i+=a+"="+this.getObjectAsString(s[a]):i+="/"+s[a]);this.isOData()&&(i+=")");var r=this.entity;return this.entity.endsWith("/")&&(r=r.substring(0,r.length-1)),r+i},this.refreshActive=function(t,e){if(this.active&&"inserted"!=this.active.__status){var s=this.getEditionURL(this.active),i=this.getKeyValues(this.active);this.$promise=$http({method:"GET",url:s,headers:this.headers}).success(function(s,a,r,n){var o=null;this.isOData()?(o=s.d,this.normalizeObject(o)):s&&s.length>0&&(o=s[0]);var h=-1,c=0;this.data.forEach(function(t){var e=!1,s=0,a=0;for(var r in i)a++,t[r]&&t[r]===i[r]&&s++;s==a&&(e=!0),e&&(h=c,o&&(this.copy(o,t),this.copy(o,this.active))),c++}.bind(this)),-1!=h?(this.events.update&&this.callDataSourceEvents("update",this.active),t&&t(this.active)):e&&e()}.bind(this)).error(function(t,s,i,a){e&&e()}.bind(this))}else t&&t(this.active)},this.buildURL=function(t){var e=this.getKeyValues(this.active),s="";this.isOData()&&(s="(");var i=0;for(var a in e)e.hasOwnProperty(a)&&(this.isOData()?s+=a+"='"+t[i]+"'":s+="/"+t[i]),i++;this.isOData()&&(s+=")");var r=this.entity;return this.entity.endsWith("/")&&(r=r.substring(0,r.length-1)),r+s},this.findObj=function(t,e,s,i){var a=this.buildURL(t);this.$promise=$http({method:"GET",url:a,headers:this.headers}).success(function(t,e,i,a){this.isOData()?(row=t.d,this.normalizeObject(row)):t&&t.length>0&&(row=t[0]),s&&s(row)}.bind(this)).error(function(t,e,s,a){i&&i()}.bind(this))},this.getColumn=function(t){var e=[];return $.each(this.data,function(s,i){e.push(i[t])}),e},this.onBackNomalState=function(){this.$scope.safeApply(function(){this.busy=!1,this.editing=!1,this.inserting=!1}.bind(this))},this.cancel=function(){this.inserting&&(this.cursor>=0?this.active=this.data[this.cursor]:this.active={}),this.editing&&(this.active=this.lastActive),this.onBackNomalState(),this.lastAction="cancel",this.dependentData&&$(this.dependentData).each(function(){this.cleanDependentBuffer()})},this.retrieveDefaultValues=function(t,e){if(t)this.active=t,this.updateWithParams(),e&&e();else if(this.entity.indexOf("cronapi")>=0||this.isOData()){var s=this.entity;s+=this.entity.endsWith("/")?"__new__":"/__new__",this.$promise=$http({method:"GET",url:this.removeSlash(s),headers:this.headers}).success(function(t,s,i,a){this.isOData()?(this.active=t.d,this.normalizeData(this.active)):this.active=t,this.updateWithParams(),e&&e()}.bind(this)).error(function(t,s,i,a){this.active={},this.updateWithParams(),e&&e()}.bind(this))}else this.active={},this.updateWithParams(),e&&e()};var updateObjectValue=function(t,e,s){for(var i=e.split("."),a=0;a<i.length;a++){var r=i[a];a==i.length-1?t[r]=s:(void 0!==t[r]&&null!=t[r]||(t[r]={}),t=t[r])}};this.updateWithParams=function(){if(this.parameters){var t=this.getParametersMap();for(var e in t)t.hasOwnProperty(e)&&updateObjectValue(this.active,e,t[e])}},this.startInserting=function(t,e){this.retrieveDefaultValues(t,function(){this.active.__$id||(this.active.__$id=uuid()),this.inserting=!0,this.onStartInserting&&this.onStartInserting(),e&&e(this.active),this.events.creating&&this.callDataSourceEvents("creating",this.active)}.bind(this))},this.startEditing=function(t,e){t?(this.active=this.copy(t),this.lastActive=t):(this.lastActive=this.active,this.active=this.copy(this.active)),this.editing=!0,e&&e(this.active),this.events.editing&&this.callDataSourceEvents("updating",this.active)},this.removeSilent=function(t,e,s){this.remove(t,null,!1,e,s,!0)},this.remove=function(t,e,s,i,a,r){this.busy=!0;var n=function(t,e){t||(t=this.active);var r=this.getKeyValues(t,s);e=e||function(e,s){for(var a=0;a<this.data.length;a++){var n;if(t.__$id&&this.data[a].__$id)n=this.data[a].__$id==t.__$id;else{var o=this.getKeyValues(this.data[a]);for(var h in r)if(r.hasOwnProperty(h)){if(!o[h]||o[h]!==r[h]){n=!1;break}n=!0}}if(n){if((this.dependentLazyPost||this.batchPost)&&"inserted"!=this.data[a].__status){this.postDeleteData||(this.postDeleteData=[]);var c=this.data[a];this.copy(this.data[a],c),c.__status="deleted",c.__originalIdx=a,this.postDeleteData.push(c),this.hasMemoryData=!0,this.events.memorydelete&&this.callDataSourceEvents("memorydelete",c)}this.data.splice(a,1);var d=a-1;d<0&&(d=0),d>this.data.length-1&&(d=this.data.length),this.data[d]?(this.active=this.data[d],this.cursor=d):(this.active=null,this.cursor=-1),this.onBackNomalState();break}}this.handleAfterCallBack(this.onAfterDelete),i&&i(t),this.events.delete&&s&&this.callDataSourceEvents("delete",t)}.bind(this),this.handleBeforeCallBack(this.onBeforeDelete)&&(!this.dependentLazyPost&&!this.batchPost||s?service.remove(this.getDeletionURL(t,s)).$promise.error(a).then(e):e())}.bind(this);!s&&!r&&this.deleteMessage&&this.deleteMessage.length>0?confirm(this.deleteMessage)?n(t,e):this.filter():n(t,e)},this.getKeyValues=function(rowData,forceOriginalKeys){for(var keys=this.keys,keyValues={},i=0;i<this.keys.length;i++){var key=this.keys[i],rowKey=null;try{rowKey=eval("rowData."+key)}catch(t){}keyValues[key]=rowKey}return keyValues}.bind(this),this.objectIsEquals=function(t,e){var s=this.getKeyValues(t),i=this.getKeyValues(e);for(var a in s)if(s.hasOwnProperty(a)){if(!i.hasOwnProperty(a))return!1;if(s[a]!==i[a])return!1}return!0},this.hasNext=function(){return this.data&&this.cursor<this.data.length-1},this.hasPrevious=function(){return this.data&&this.cursor>0},this.order=function(t){this._savedProps.order=t},this.getActiveValues=function(){return this.active&&!this._activeValues&&$rootScope.$watch(function(t){return this.active}.bind(this),function(t,e){this._activeValues=this.getRowValues(this.active)}.bind(this),!0),this._activeValues},this.__defineGetter__("activeValues",function(){return _self.getActiveValues()}),this.getRowValues=function(t){var e=[];for(var s in t)t.hasOwnProperty(s)&&e.push(t[s]);return e},this.next=function(){return this.hasNext()||this.nextPage(),this.active=this.copy(this.data[++this.cursor],{}),this.active},this.nextPage=function(){var t=(window.hostApp||"")+this.entity;this.hasNextPage()&&(1==this.apiVersion||-1==t.indexOf("/cronapi/")?this.offset=parseInt(this.offset)+parseInt(this.rowsPerPage):this.offset=parseInt(this.offset)+1,this.fetch(this._savedProps,{success:function(e){(!e||e.length<parseInt(this.rowsPerPage))&&(1!=this.apiVersion&&-1!=t.indexOf("/cronapi/")||(this.offset=parseInt(this.offset)-this.data.length))}},!0))},this.prevPage=function(){this.append||this.preppend||(this.offset=parseInt(this.offset)-this.data.length,this.offset<0?this.offset=0:this.offset>=0&&this.fetch(this._savedProps,{success:function(t){t&&0!==t.length||(this.offset=0)}},!0))},this.hasNextPage=function(){return this.hasMoreResults&&-1!=this.rowsPerPage},this.hasPrevPage=function(){return this.offset>0&&!this.append&&!this.prepend},this.previous=function(){if(!this.hasPrevious())throw"Dataset Overflor Error";return this.active=this.copy(this.data[--this.cursor],{}),this.active},this.goTo=function(t){if("object"==typeof t){var e;this.data.length>0&&(e=this.getKeyValues(this.data[0]));for(var s=0;s<this.data.length;s++){var i=!1;if(t.__$id&&this.data[s].__$id)i=t.__$id==this.data[s].__$id;else{var a=this.data[s];for(var r in e)i=!(!t.hasOwnProperty(r)||t[r]!==a[r])}if(i){this.cursor=s,this.active=this.copy(this.data[this.cursor],{});var n=this.getKeyValues(this.data[this.cursor]),o=!0;for(var r in n)if(void 0===n[r]){o=!1;break}return o||this.fetchChildren(),this.active}}}else for(var s=0;s<this.data.length;s++)if(this.data[s][this.key]===t)return this.cursor=s,this.active=this.copy(this.data[this.cursor],{}),this.active},this.getCursor=function(){return this.cursor},this.filter=function(t,e){var s=this.offset;this.offset=0,this.fetch({path:t},{beforeFill:function(t){this.cleanup()},error:function(t){this.offset=s},success:function(t){e&&e(t)}})},this.doSearchAll=function(t,e){this.searchTimeout=null;var s=this.offset;this.offset=0,this.fetch({params:{filter:"%"+t+"%",filterCaseInsensitive:!!e}},{beforeFill:function(t){this.cleanup()},error:function(t){this.offset=s}})},this.searchAll=function(t,e){this.searchTimeout&&(clearTimeout(this.searchTimeout),this.searchTimeout=null),this.searchTimeout=setTimeout(function(){this.doSearchAll(t,e)}.bind(this),500)},this.doSearch=function(t,e){this.searchTimeout=null;var s=this.offset;this.offset=0;var i;this.isOData()?(i={params:{$filter:t}},null!=t&&0!=t.length||(i={})):i={params:{filter:t,filterCaseInsensitive:!!e}},this.fetch(i,{beforeFill:function(t){this.cleanup()},error:function(t){this.offset=s}})},this.search=function(t,e){this.searchTimeout&&(clearTimeout(this.searchTimeout),this.searchTimeout=null),this.caseInsensitive=e,this.terms=t,this.searchTimeout=setTimeout(function(){this.doSearch(t,e)}.bind(this),500)},this.refresh=function(t,e,s){this.cleanup(),void 0===s&&(s=0),t.length>=s&&this.filter(e+"/"+t)},this.cleanup=function(){this.offset=0,this.rowsCount=-1,this.data.length=0,this.cursor=-1,this.active={},this.hasMoreResults=!1},this.current=function(){return this.active||this.data[0]},this.getLink=function(t){if(this.links)for(var e=0;e<this.links.length;e++)if(this.links[e].rel==t)return this.links[e].href},this.isOData=function(){return this.entity.indexOf("odata")>0},this.normalizeValue=function(t,e){if("string"==typeof t){if(t.length>=10&&t.match(ISO_PATTERN))return new Date(t);if(t.length>=8&&t.match(TIME_PATTERN)){var s=TIME_PATTERN.exec(t);return new Date(Date.UTC(1970,0,1,s[1],s[2],s[3]))}if(t.length>=10&&"/Date("==t.substring(0,6)&&")/"==t.substring(t.length-2,t.length)){var i=t.substring(6,t.length-2);return new Date(parseInt(i))}if(t.length>=20&&"datetime'"==t.substring(0,9)&&"'"==t.substring(t.length-1,t.length)){var i=t.substring(9,t.length-1);return new Date(i)}if(t.length>=20&&"datetimeoffset'"==t.substring(0,15)&&"'"==t.substring(t.length-1,t.length)){var i=t.substring(15,t.length-1);return new Date(i)}if(e){if(t.length>2&&"'"==t.charAt(0)&&"'"==t.charAt(t.length-1)){var i=t.substring(1,t.length-1);return i}if("true"==t||"false"==t)return"true"==t;if("null"==t)return null;if(""!=t)return parseFloat(t)}}return t},this.normalizeObject=function(t){for(var e in t)if(t.hasOwnProperty(e)){var s=t[e];s&&("object"==typeof s?this.normalizeObject(s):t[e]=this.normalizeValue(s))}},this.normalizeData=function(t){if(t){delete t.__metadata;for(var e=0;e<t.length;e++)this.normalizeObject(t[e])}return t},this.getAllData=function(){var t=[];if(t=t.concat(this.data),this.memoryData)for(key in this.memoryData)if(this.memoryData.hasOwnProperty(key)){var e=this.memoryData[key];e.data&&(t=t.concat(e.data))}return this.postDeleteData&&(t=t.concat(this.postDeleteData)),t},this.getParametersMap=function(parentId){var map={},parameters,obj,mapParams;if(parentId){parameters=this.parametersExpression;for(var arr=eval(this.dependentLazyPost).getAllData(),i=0;i<arr.length;i++)if(arr[i].__$id==parentId){obj=arr[i];break}mapParams=this.getParametersMap()}else parameters=this.parameters;if(parameters&&parameters.length>0)for(var parts=parameters.split(";"),i=0;i<parts.length;i++){var part=parts[i],binary=part.split("=");if(2==binary.length){var value=binary[1];if(parentId)if(binary[1].match(DEP_PATTERN)){var g=DEP_PATTERN.exec(value);if(-1!=g[1].indexOf(".active.")){var field=g[1].replace(this.dependentLazyPost+".active.","");obj&&(map[binary[0]]=obj[field])}else map[binary[0]]=mapParams[binary[0]]}else map[binary[0]]=mapParams[binary[0]];else map[binary[0]]=binary[1]?this.normalizeValue(value,!0):null}}return map},this.setParameters=function(t){this.parameters=t,this.fetch({params:{}})},this.removeSlash=function(t){return 0==t.indexOf("http://")?"http://"+t.substring(7).split("//").join("/"):0==t.indexOf("https://")?"https://"+t.substring(8).split("//").join("/"):t},this.setDataSourceEvents=function(t){this.events=t},this.addDataSourceEvents=function(t){for(var e in t)t.hasOwnProperty(e)&&(this.events[e]||(this.events[e]=[]),"[object Array]"!==Object.prototype.toString.call(this.events[e])&&(this.events[e]=[this.events[e]]),this.events[e].push(t[e]))},this.removeDataSourceEvents=function(t){for(var e in t)if(t.hasOwnProperty(e)){this.events[e]||(this.events[e]=[]),
"[object Array]"!==Object.prototype.toString.call(this.events[e])&&(this.events[e]=[this.events[e]]);for(var s=[].concat(this.events[e]),i=0;i<s.length;i++)s[i]==t[e]&&this.events[e].splice(i,1)}},this.callDataSourceEvents=function(t,e){if(this.events){var s=this.events[t];if(s){"[object Array]"!==Object.prototype.toString.call(s)&&(s=[s]);for(var i=[],a=1;a<arguments.length;a++)i.push(arguments[a]);for(var r=0;r<s.length;r++)s[r].apply(null,i)}}},this.storeInMemory=function(t){this.memoryData||(this.memoryData={});var e={data:[],cursor:this.cursor,params:this.getParametersMap(),rowCount:this.getRowsCount()};e.data=deepCopy(this.data,e.data),this.memoryData[t]=e},this.restoreFromMemory=function(t){this.memoryData||(this.memoryData={});var e=this.memoryData[t];return e&&(this.cursor=e.cursor,this.rowsCount=e.rowCount),delete this.memoryData[t],deepCopy(e.data)},this.hasPendingChanges=function(){var t=this.hasMemoryData;return this.children&&$(this.children).each(function(){t=t||this.hasPendingChanges()}),t},this.fetchChildren=function(t){this.children?reduce(this.children,function(t,e){t.fetch({},function(){e()})}.bind(this),function(){t&&t()}.bind(this)):t&&t()};var splitExpression=function(t){var e,s=null;-1!=t.indexOf("@=")?(s=t.trim().split("@="),e="="):-1!=t.indexOf("<=")?(s=t.trim().split("<="),e="<="):-1!=t.indexOf(">=")?(s=t.trim().split(">="),e=">="):-1!=t.indexOf(">")?(s=t.trim().split(">"),e=">"):-1!=t.indexOf("<")?(s=t.trim().split("<"),e="<"):(s=t.trim().split("="),e="=");var i=typeof this.normalizeValue(s[1],!0);return this.isOData()?"="==e&&"string"==i?"startswith(tolower("+s[0]+"), "+s[1].toLowerCase()+")":"="==e?s[0]+" eq "+s[1]:"!="==e?s[0]+" ne "+s[1]:">"==e?s[0]+" gt {"+s[1]:">="==e?s[0]+" ge "+s[1]:"<"==e?s[0]+" lt "+s[1]:"<="==e?s[0]+" le "+s[1]:void 0:"string"==i?s[0]+"@"+e+"%"+s[1]+"%":s[0]+e+s[1]}.bind(this),parseFilterExpression=function(t){var e="";if(t)for(var s=t.split(";"),i=0;i<s.length;i++){var a=splitExpression(s[i]);""!=e&&(e+=this.isOData()?" and ":";"),e+=a}return e}.bind(this);this.fetch=function(properties,callbacksObj,isNextOrPrev){var callbacks=callbacksObj||{},sucessHandler=function(data,headers,raw){var springVersion=!1;this.responseHeaders=headers||{};var total=-1;this.entity.indexOf("//")>-1&&this.entity.indexOf("://")<0&&(data=[]),raw||(data?"[object Array]"!==Object.prototype.toString.call(data)&&(data&&data.links&&"[object Array]"===Object.prototype.toString.call(data.content)?(this.links=data.links,data=data.content,springVersion=!0):this.isOData()?(total=parseInt(data.d.__count),data=data.d.results,this.normalizeData(data)):data=[data]):data=[]);for(var n=0;n<data.length;n++)data[n].__$id||(data[n].__$id=uuid());if(callbacks.beforeFill&&callbacks.beforeFill.apply(this,this.data),isNextOrPrev?(this.prepend&&Array.prototype.unshift.apply(this.data,data),this.append&&Array.prototype.push.apply(this.data,data),this.prepend||this.append||(Array.prototype.push.apply(this.data,data),this.data.length>0?(this.active=data[0],this.cursor=0):(this.active={},this.cursor=-1))):(this.cleanup(),-1!=total&&(this.rowsCount=total),Array.prototype.push.apply(this.data,data),this.data.length>0&&(this.active=data[0],this.cursor=0)),this.columns=[],this.data.length>0)for(var i=0;i<this.data[0].length;i++)this.columns.push(this.getColumn(i));callbacks.success&&callbacks.success.call(this,data),this.events.read&&this.callDataSourceEvents("read",data),this.hasMoreResults=data.length>=this.rowsPerPage,springVersion&&(this.hasMoreResults=null!=this.getLink("next")),this.autoPost&&this.startAutoPost(),this.loaded=!0,this.loadedFinish=!0,this.handleAfterCallBack(this.onAfterFill);var thisDatasourceName=this.name;$("datasource").each(function(idx,elem){var dependentBy=null,dependent=window[elem.getAttribute("name")];if(dependent&&""!==elem.getAttribute("dependent-by")&&null!=elem.getAttribute("dependent-by")){try{dependentBy=JSON.parse(elem.getAttribute("dependent-by"))}catch(ex){dependentBy=eval(elem.getAttribute("dependent-by"))}dependentBy?dependentBy.name==thisDatasourceName&&(dependent.filterURL||eval(dependent.name).fetch()):console.log("O dependente "+elem.getAttribute("dependent-by")+" do pai "+thisDatasourceName+" ainda não existe.")}})}.bind(this);if(this.busy)return void(callbacks.canceled&&callbacks.canceled());if(this.entity.indexOf("//")>-1&&this.entity.indexOf("://")<0)return void(callbacks.canceled&&callbacks.canceled());if(!this.enabled)return this.cleanup(),void(callbacks.canceled&&callbacks.canceled());var props=properties||{};props.params=props.params||{};var resourceURL=(window.hostApp||"")+this.entity+(props.path||this.lastFilterParsed||""),filter="",order="",cleanData=!1,canProceed=!0;if(this.parameters&&this.parameters.length>0)for(var parts=this.parameters.split(";"),partsExpression=this.parametersExpression.split(";"),i=0;i<parts.length;i++){var part=parts[i],partExpression=partsExpression[i],binary=part.split("="),binaryExpression=partExpression.split("=");if(2==binary.length){""!=filter&&(filter+=this.isOData()?" and ":";"),filter+=binary[0],filter+=this.isOData()?" eq ":"=";var g=DEP_PATTERN.exec(binaryExpression[1]);if(!binary[1]&&this.dependentLazyPost&&g[1]&&g[1].startsWith(this.dependentLazyPost+".")){cleanData=!0;var dds=eval(this.dependentLazyPost);dds.active&&dds.active.__$id?filter+=eval(this.dependentLazyPost).active.__$id:filter+="memory"}else!binary[1]&&g[1]?(filter+="null",cleanData=!0):filter+=this.getObjectAsString(this.normalizeValue(binary[1],!0))}}if(!canProceed)return void(callbacks.canceled&&callbacks.canceled());if(this.condition){var conditionFilter=parseFilterExpression(this.condition);conditionFilter&&(""!=filter&&(filter+=this.isOData()?" and ":";"),filter+=conditionFilter)}if(this.orderBy)for(var orders=this.orderBy.split(";"),i=0;i<orders.length;i++){var orderField=orders[i];orderField&&(""!=order&&(order+=this.isOData()?",":";"),this.isOData()?order+=orderField.replace("|ASC"," asc").replace("|DESC"," desc"):order+=orderField)}if(this.dependentLazyPost&&!this.parameters&&eval(this.dependentLazyPost).active){var checkRequestId="",keyDependentLazyPost=this.getKeyValues(eval(this.dependentLazyPost).active);for(var key in keyDependentLazyPost){checkRequestId=keyDependentLazyPost[key];break}if(checkRequestId&&checkRequestId.length>0&&-1==resourceURL.indexOf(checkRequestId))return void(callbacks.canceled&&callbacks.canceled())}this.rowsPerPage>0&&(this.isOData()?(props.params.$top=this.rowsPerPage,props.params.$skip=parseInt(this.offset)*parseInt(this.rowsPerPage),props.params.$inlinecount="allpages"):1==this.apiVersion||-1==resourceURL.indexOf("/cronapi/")?(props.params.limit=this.rowsPerPage,props.params.offset=this.offset):(props.params.size=this.rowsPerPage,props.params.page=this.offset));var paramFilter=null;this.isOData()&&props.params.$filter&&(paramFilter=props.params.$filter),!this.isOData()&&props.params.filter&&(paramFilter=props.params.filter),paramFilter&&(filter&&""!=filter&&(this.isOData()?filter+=" and ":filter+=";"),filter+=paramFilter);var paramOrder=null;this.isOData()&&props.params.$orderby&&(paramOrder=props.params.$orderby),!this.isOData()&&props.params.order&&(paramOrder=props.params.order),paramOrder&&(order=paramOrder),filter&&(this.isOData()?props.params.$filter=filter:props.params.filter=filter),order&&(this.isOData()?props.params.$orderby=order:props.params.order=order);var localSuccess;if(this.hasMemoryData&&filter){if(this.memoryData||(this.memoryData={}),this.lastFilter==filter)return void(callbacks.canceled&&callbacks.canceled());var id=filter,mem=this.memoryData[id];if(mem){this.storeInMemory(this.lastFilter);var data=this.restoreFromMemory(id);return this.lastFilter=filter,void sucessHandler(data,null,!0)}localSuccess=function(){this.storeInMemory(this.lastFilter)}.bind(this)}if(this.stopAutoPost(),this._savedProps=props,cleanData)return localSuccess&&localSuccess(),this.lastFilter=filter,void sucessHandler([],null,!0);this.busy=!0,this.$promise=$http({method:"GET",url:this.removeSlash(resourceURL),params:props.params,headers:this.headers}).success(function(t,e,s,i){localSuccess&&localSuccess(),this.lastFilter=filter,this.busy=!1,sucessHandler(t,s())}.bind(this)).error(function(t,e,s,i){this.busy=!1,this.handleError(t),callbacks.error&&callbacks.error.call(this,t)}.bind(this))},this.getRowsCount=function(){return-1!=this.rowsCount?this.rowsCount:this.data.length},this.notifyObservers=function(){for(var t in this.observers)if(this.observers.hasOwnProperty(t)){var e=this.observers[t];$timeout(function(){e.notify.call(e,this.active)}.bind(this),1)}},this.notify=function(t){if(t){var e=this.watchFilter,s=/\{([A-z][A-z|0-9]*)\}/gim;e=e.replace(s,function(e,s){return t.hasOwnProperty(s)?t[s]:""}),this.fetch({params:{q:e}})}},this.addObserver=function(t){this.observers.push(t)},this.sum=function(t){for(var e=0,s=0;s<this.data.length;s++)this.data[s][t]&&(e+=this.data[s][t]);return e},this.copy=function(t,e){if(null===t||"[object Object]"!==Object.prototype.toString.call(t))return t;e=e||{};for(var s in t)t.hasOwnProperty(s)&&-1==s.indexOf("$$")&&(e[s]=this.copy(t[s]));for(var s in e)"__$id"!=s&&void 0==t[s]&&delete e[s];return e};var deepCopyArray=function(t,e){if(null===t||"[object Array]"!==Object.prototype.toString.call(t))return t;e=e||[];for(var s=0;s<t.length;s++)e.push(deepCopy(t[s]));return e},deepCopy=function(t,e){if("[object Array]"===Object.prototype.toString.call(t))return deepCopyArray(t,e);if(null===t||"[object Object]"!==Object.prototype.toString.call(t))return t;e=e||{};for(var s in t)t.hasOwnProperty(s)&&(e[s]=deepCopy(t[s]));return e};if(this.startAutoPost=function(){this.unregisterDataWatch=$rootScope.$watch(function(){return this.data}.bind(this),function(t,e){if(!this.enabled)return void this.unregisterDataWatch();var s=t.length-e.length;if(s>0)for(var i=1;i<=s;i++)this.insert(t[t.length-i],function(){});else if(s<0)for(var a=this,r=e.filter(function(e){return 0==t.filter(function(t){return a.objectIsEquals(e,t)}).length}),i=0;i<r.length;i++)this.remove(r[i],function(){})}.bind(this))},this.stopAutoPost=function(){this.unregisterDataWatch&&(this.unregisterDataWatch(),this.unregisterDataWatch=void 0)},this.hasDataBuffered=function(){return!!(this.dependentBufferLazyPostData&&this.dependentBufferLazyPostData.length>0)},window.afterDatasourceCreate){var args=[$q,$timeout,$rootScope,$window,Notification];window.afterDatasourceCreate.apply(this,args)}this.init()};return this.storeDataset=function(t){this.datasets[t.name]=t},this.initDataset=function(props,scope){var endpoint=props.endpoint?props.endpoint:"",dts=new DataSet(props.name,scope);$rootScope[props.name]=dts,window[props.name]=dts;var defaultApiVersion=1;if(dts.entity=props.entity,window.dataSourceMap&&window.dataSourceMap[dts.entity]&&(dts.entity=window.dataSourceMap[dts.entity].serviceUrlODATA||window.dataSourceMap[dts.entity].serviceUrl),app&&app.config&&app.config.datasourceApiVersion&&(defaultApiVersion=app.config.datasourceApiVersion),dts.apiVersion=props.apiVersion?parseInt(props.apiVersion):defaultApiVersion,dts.keys=props.keys&&props.keys.length>0?props.keys.split(","):[],dts.rowsPerPage=props.rowsPerPage?props.rowsPerPage:100,dts.append=props.append,dts.prepend=props.prepend,dts.endpoint=props.endpoint,dts.filterURL=props.filterURL,dts.autoPost=props.autoPost,dts.deleteMessage=props.deleteMessage,dts.enabled=props.enabled,dts.offset=props.offset?props.offset:0,dts.onError=props.onError,dts.defaultNotSpecifiedErrorMessage=props.defaultNotSpecifiedErrorMessage,dts.onAfterFill=props.onAfterFill,dts.onBeforeCreate=props.onBeforeCreate,dts.onAfterCreate=props.onAfterCreate,dts.onBeforeUpdate=props.onBeforeUpdate,dts.onAfterUpdate=props.onAfterUpdate,dts.onBeforeDelete=props.onBeforeDelete,dts.onAfterDelete=props.onAfterDelete,dts.dependentBy=props.dependentBy,dts.parameters=props.parameters,dts.parametersExpression=props.parametersExpression,dts.checkRequired=props.checkRequired,dts.batchPost=props.batchPost,dts.condition=props.condition,dts.orderBy=props.orderBy,props.dependentLazyPost&&props.dependentLazyPost.length>0&&(dts.dependentLazyPost=props.dependentLazyPost,eval(dts.dependentLazyPost).addDependentDatasource(dts)),dts.dependentLazyPostField=props.dependentLazyPostField,props.headers&&props.headers.length>0){dts.headers={"X-From-DataSource":"true"};for(var headers=props.headers.trim().split(";"),header,i=0;i<headers.length;i++)header=headers[i].split(":"),2===header.length&&(dts.headers[header[0]]=header[1])}if(this.storeDataset(dts),dts.allowFetch=!0,dts.dependentBy&&""!==dts.dependentBy&&""!==dts.dependentBy.trim()){dts.allowFetch=!1;var dependentBy=null;try{dependentBy=JSON.parse(dependentBy)}catch(ex){dependentBy=eval(dependentBy)}dependentBy&&dependentBy.loadedFinish&&(dts.allowFetch=!0)}if(!props.lazy&&dts.allowFetch&&"[object String]"!==Object.prototype.toString.call(props.watch)&&!props.filterURL){var queryObj={};dts.fetch({params:queryObj},{success:function(t){t&&t.length>0&&(this.active=t[0],this.cursor=0)}})}return props.lazy&&props.autoPost&&dts.startAutoPost(),props.watch&&"[object String]"===Object.prototype.toString.call(props.watch)&&(this.registerObserver(props.watch,dts),dts.watchFilter=props.watchFilter),props.filterURL&&props.filterURL.length>0&&dts.allowFetch&&dts.filter(props.filterURL),dts},this.registerObserver=function(t,e){this.datasets[t].addObserver(e)},this}]).directive("datasource",["DatasetManager","$timeout","$parse","Notification","$translate","$location",function(t,e,s,i,a,r){return{restrict:"E",scope:!0,template:"",link:function(s,i,n){!function(){var o="origin-path:"+r.path();void 0===n.headers||null===n.headers?n.headers=o:n.headers=n.headers.concat(";",o);var h,c={name:n.name,entity:n.entity,apiVersion:n.apiVersion,enabled:!n.hasOwnProperty("enabled")||"true"===n.enabled,keys:n.keys,endpoint:n.endpoint,lazy:"true"===n.lazy,append:!n.hasOwnProperty("append")||"true"===n.append,prepend:n.hasOwnProperty("prepend")&&""===n.prepend||"true"===n.prepend,watch:n.watch,rowsPerPage:n.rowsPerPage,offset:n.offset,filterURL:n.filter,watchFilter:n.watchFilter,deleteMessage:n.deleteMessage||""===n.deleteMessage?n.deleteMessage:a.instant("General.RemoveData"),headers:n.headers,autoPost:"true"===n.autoPost,onError:n.onError,onAfterFill:n.onAfterFill,onBeforeCreate:n.onBeforeCreate,onAfterCreate:n.onAfterCreate,onBeforeUpdate:n.onBeforeUpdate,onAfterUpdate:n.onAfterUpdate,onBeforeDelete:n.onBeforeDelete,onAfterDelete:n.onAfterDelete,defaultNotSpecifiedErrorMessage:a.instant("General.ErrorNotSpecified"),dependentBy:n.dependentBy,dependentLazyPost:n.dependentLazyPost,batchPost:"true"===n.batchpost,dependentLazyPostField:n.dependentLazyPostField,parameters:n.parameters,parametersExpression:$(i).attr("parameters"),condition:n.condition,orderBy:n.orderBy,checkRequired:!n.hasOwnProperty("checkrequired")||""===n.checkrequired||"true"===n.checkrequired},d={filter:!0,entity:!0,enabled:!0,parameters:!0},l=t.initDataset(c,s);n.$observe("filter",function(t){d.filter?e(function(){d.filter=!1},0):(e.cancel(h),h=e(function(){l.events.overRideRefresh?l.callDataSourceEvents("overRideRefresh","filter",t):l.filter(t,function(t){l.events.refresh&&l.callDataSourceEvents("refresh",t,"filter")}),l.lastFilterParsed=t},100))}),n.$observe("parameters",function(t){l.parameters!=t&&(l.parameters=t,e.cancel(h),h=e(function(){l.events.overRideRefresh?l.callDataSourceEvents("overRideRefresh","parameters",l.parameters):l.fetch({params:{}},{success:function(t){l.events.refresh&&l.callDataSourceEvents("refresh",t,"parameters")}})},0))}),n.$observe("enabled",function(t){var s="true"===t;l.enabled!=s&&(l.enabled=s,l.enabled&&(e.cancel(h),h=e(function(){l.events.overRideRefresh?l.callDataSourceEvents("overRideRefresh","enabled",l.parameters):l.fetch({params:{}},{success:function(t){l.events.refresh&&l.callDataSourceEvents("refresh",t,"enabled")}})},200)))}),n.$observe("entity",function(t){l.entity=t,window.dataSourceMap&&window.dataSourceMap[l.entity]&&(l.entity=window.dataSourceMap[l.entity].serviceUrlODATA||window.dataSourceMap[l.entity].serviceUrl),d.entity?e(function(){d.entity=!1}):(e.cancel(h),h=e(function(){l.fetch({params:{}},{success:function(t){l.events.refresh&&l.callDataSourceEvents("refresh",t,"entity")}})},200))})}()}}}]).directive("crnDatasource",["DatasetManager","$parse","$rootScope",function(t,e,s){return{restrict:"A",scope:!0,priority:9999999,link:function(i,a,r){i.data=t.datasets,i.data[r.crnDatasource]?i.datasource=i.data[r.crnDatasource]:(i.datasource={},i.datasource.data=e(r.crnDatasource)(i)),i.$on("$destroy",function(){delete s[r.crnDatasource]})}}}]);